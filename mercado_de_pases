-- Creación de esquema para app Mercado de Pases
CREATE schema mercado_de_pases;
-- Usar esquema Mercado de Pases
USE mercado_de_pases;
-- Creación de tablas del esquema Mercado de Pases
CREATE table jugadores(
			ID_Jugador INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
            Nombre_Jugador VARCHAR(50) NOT NULL,
            País VARCHAR(30) NOT NULL,
            Posición VARCHAR(30) NOT NULL,
            Fecha_de_Nac DATE NOT NULL,
            ID_Club INT,
            ID_Agente INT,
            Situación_Contractual VARCHAR(30) NOT NULL,
            Salario_Anual_USD FLOAT,
            Cant_de_Partidos INT,
            Cant_de_Goles INT);
CREATE table Agentes(
			ID_Agente INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
            Nombre_Agente VARCHAR(50) NOT NULL,
            País VARCHAR(30) NOT NULL);
CREATE table Clubes(
			ID_Club INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
            Nombre_Club VARCHAR(100) NOT NULL,
            País VARCHAR(30) NOT NULL,
            ID_Liga INT NOT NULL,
            Liga VARCHAR(50) NOT NULL);
CREATE table Ligas(
			ID_Liga INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
            Nombre_Liga VARCHAR(50) NOT NULL,
            Confederación VARCHAR(50) NOT NULL,
            País VARCHAR(30) NOT NULL);
CREATE table Videos(
			ID_Video INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
            Nombre_Video VARCHAR(200) NOT NULL,
            Link VARCHAR(2048) NOT NULL,
            ID_Jugador INT NOT NULL,
            Nombre_Jugador VARCHAR(50) NOT NULL);
CREATE table Negociaciones(
			ID_Negociación INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
            ID_Jugador INT NOT NULL,
            Fecha DATE NOT NULL,
            ID_Agente INT NOT NULL,
            ID_Club INT NOT NULL,
            Nombre_Club VARCHAR(100) NOT NULL,
            Salario_Ofrecido FLOAT NOT NULL,
            Aceptada_SI_NO VARCHAR(10));
-- Creación de llaves foráneas Tabla Jugadores
ALTER TABLE Jugadores
ADD FOREIGN KEY (ID_Club) REFERENCES Clubes(ID_Club);
ALTER TABLE Jugadores
ADD FOREIGN KEY (ID_Agente) REFERENCES agentes(ID_Agente);
-- Creación de llaves foráneas Tabla Clubes
ALTER TABLE Clubes
ADD FOREIGN KEY (ID_Liga) REFERENCES Ligas(ID_Liga);
-- Creación de llaves foráneas Tabla Videos
ALTER TABLE Videos
ADD FOREIGN KEY (ID_Jugador) REFERENCES Jugadores(ID_Jugador);
-- Creación de llaves foráneas Tabla Negociaciones
ALTER TABLE Negociaciones
ADD FOREIGN KEY (ID_Jugador) REFERENCES jugadores(ID_Jugador);
ALTER TABLE negociaciones
ADD FOREIGN KEY (ID_Agente) REFERENCES Agentes(ID_Agente);
ALTER TABLE negociaciones
ADD FOREIGN KEY (ID_Club) REFERENCES Clubes(ID_Club);
ALTER TABLE jugadores ALTER COLUMN Cant_de_Goles SET DEFAULT 0;
ALTER TABLE jugadores ALTER COLUMN Cant_de_Partidos SET DEFAULT 0;



-- Usar schema mercado de pases
USE mercado_de_pases;

-- Vista 1
-- Crear vista Arqueros que usan la aplicación
CREATE VIEW Arqueros AS
	(SELECT 
    Nombre_Jugador as Nombre
    , País
	, Cant_de_Partidos as Partidos
    from Jugadores
    where Posición = "Arquero"
    );
-- Realizar consulta de la vista Arqueros
SELECT * from Arqueros;

-- Vista 2
-- Crear vista clubes de Argentina
CREATE VIEW Clubes_Argentinos AS
	(SELECT 
    Nombre_Club as Club
    , Liga
    from Clubes
    where País = "Argentina"
    );
-- Realizar consulta de la vista Clubes_Argentinos
SELECT * from Clubes_Argentinos;

-- Vista 3
-- Crear vista Ranking Goleadores
CREATE VIEW Ranking_Goleadores AS
	(SELECT 
    Nombre_Jugador as Nombre
    , Posición
    , Cant_de_Goles as Goles
    from Jugadores
    ORDER BY Goles DESC
    );
-- Realizar consulta de la vista Ranking_Goleadores
SELECT * from Ranking_Goleadores;

-- Vista 4
-- Crear vista Jugadores con más de 100 partidos
CREATE VIEW Jugadores_Experimentados AS
	(SELECT 
    Nombre_Jugador as Nombre
    , Posición
    , Cant_de_Partidos as Partidos
    from Jugadores
    WHERE Cant_de_Partidos > 100
    ORDER BY Partidos DESC
    );
-- Realizar consulta de la vista Jugadores_Experimentados
SELECT * from Jugadores_Experimentados;

-- Vista 5
-- Crear vista Negociaciones Aceptadas
CREATE VIEW Negociaciones_Aceptadas AS
	(SELECT 
    ID_Negociación as Negociación
    , Nombre_Jugador as Nombre
    , aceptada_si_no as Resultado
    from Negociaciones n
	JOIN Jugadores j ON (n.ID_Jugador = j.ID_Jugador)
    WHERE aceptada_si_no = "SI"
    );
-- Realizar consulta de la vista Jugadores_Experimentados
SELECT * from Negociaciones_Aceptadas;

-- usar schema mercado_de_pases
USE mercado_de_pases;

-- Función 1
-- Crear función Promedio de Gol
DELIMITER $$
CREATE FUNCTION Promedio_de_Gol (
	 ID_Goleador INT)
     RETURNS FLOAT
NO SQL
BEGIN
	DECLARE Promedio FLOAT;
    SET Promedio = (
	SELECT (Cant_de_Goles/Cant_de_Partidos)
	FROM jugadores
    WHERE ID_Jugador = ID_Goleador );
	RETURN Promedio ;
END;
$$ ;

-- Llamar Función
SELECT Promedio_de_Gol(2);

-- Función 2
-- Crear función Buscar Nombre Agente
DELIMITER $$
CREATE FUNCTION Buscar_Agente (
	 ID_Agente_Buscado INT)
     RETURNS VARCHAR(50)
DETERMINISTIC
BEGIN
	DECLARE Nombre VARCHAR(50);
    SET Nombre = (
	SELECT 
		Nombre_Agente
	FROM agentes
    WHERE ID_Agente = ID_Agente_Buscado );
	RETURN Nombre ;
END;
$$ ;

-- Llamar Función
SELECT Buscar_Agente(6);
